<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Portfolio Rebalancer - Hackathon Edition</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>ðŸš€ Smart Portfolio Rebalancer (Hackathon Edition)</h1>
    <p class="subtitle">Institutional-grade drift monitoring, AI-augmented weight optimization, and multi-agent orchestration blueprint.</p>

    <section class="controls">
      <label>Portfolio Value ($)<input id="portfolioValue" type="number" value="100000" min="1000" step="1000"></label>
      <label>Drift Threshold (%)<input id="driftThreshold" type="number" value="2" min="0" step="0.1"></label>
      <label>Turnover Limit (%)<input id="turnoverLimit" type="number" value="20" min="1" step="1"></label>
      <label>Tx Cost (bps)<input id="txCost" type="number" value="10" min="0" step="1"></label>
      <button id="addRowBtn" type="button">Add Asset</button>
      <button id="runBtn" type="button">Run AI Rebalance</button>
      <button id="copilotBtn" type="button">Generate AI Copilot Brief</button>
    </section>

    <section class="preview-strip">
      <h2>Preview Scenarios</h2>
      <div class="controls">
        <label>Scenario
          <select id="scenarioSelect"></select>
        </label>
        <button id="loadScenarioBtn" type="button">Load Scenario</button>
      </div>
      <p id="scenarioDescription" class="subtitle"></p>
    </section>

    <section>
      <h2>Field Editor</h2>
      <table id="assetTable">
        <thead>
          <tr>
            <th>Asset</th><th>Target %</th><th>Current %</th><th>Market Return %</th><th>Price</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Rebalance Recommendations</h2>
      <table id="resultTable">
        <thead>
          <tr>
            <th>Asset</th><th>Current %</th><th>Target %</th><th>AI Target %</th><th>Drift %</th><th>Forecast %</th><th>Action</th><th>Trade $</th><th>Units</th><th>Est. Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p><strong>Turnover Used:</strong> <span id="turnoverUsed">-</span> | <strong>Total Tx Cost:</strong> <span id="txCostTotal">-</span></p>
    </section>

    <section class="metrics">
      <h2>Risk Metrics</h2>
      <div class="metric-card">Volatility <span id="volatility">-</span></div>
      <div class="metric-card">Sharpe <span id="sharpe">-</span></div>
      <div class="metric-card">Max Drawdown <span id="drawdown">-</span></div>
      <div class="metric-card">VaR 95 <span id="var95">-</span></div>
      <div class="metric-card">CVaR 95 <span id="cvar95">-</span></div>
      <div class="metric-card">Expected Annual Return <span id="expRet">-</span></div>
      <div class="metric-card">Tracking Error <span id="trackingError">-</span></div>
      <div class="metric-card">MC Prob. of Loss <span id="mcLoss">-</span></div>
    </section>

    <section class="insights-grid">
      <div>
        <h2>ML House View</h2>
        <p><strong>Top Conviction Buys:</strong> <span id="convictionBuys">-</span></p>
        <p><strong>Risk Reduction Candidates:</strong> <span id="riskReduction">-</span></p>
        <ul id="modelsList"></ul>
      </div>
      <div>
        <h2>Multi-Agent Architecture</h2>
        <ol id="agentList"></ol>
        <p><strong>Flow:</strong> <span id="agentFlow">-</span></p>
      </div>
    </section>

    <section>
      <h2>AI Copilot Briefing</h2>
      <pre id="copilotPreview" class="api-preview">Generate copilot brief for executive summary...</pre>
    </section>

    <section>
      <h2>API Preview Output</h2>
      <pre id="apiPreview" class="api-preview">Run a scenario to preview the API response...</pre>
    </section>
  </div>

  <script>
    const defaultRows = [
      { asset: 'Mutual Fund', target_weight: 25, current_weight: 23, market_return: 1.5, price: 42 },
      { asset: 'ETF', target_weight: 20, current_weight: 24, market_return: 2.2, price: 95 },
      { asset: 'Stocks', target_weight: 20, current_weight: 18, market_return: -0.8, price: 130 },
      { asset: 'Commodity', target_weight: 10, current_weight: 12, market_return: 1.2, price: 77 },
      { asset: 'FX', target_weight: 10, current_weight: 8, market_return: 0.4, price: 1.2 },
      { asset: 'Crypto', target_weight: 15, current_weight: 15, market_return: 3.1, price: 26000 }
    ];

    let scenarioData = [];
    const tbody = document.querySelector('#assetTable tbody');
    const resultBody = document.querySelector('#resultTable tbody');

    function clearRows() {
      tbody.innerHTML = '';
    }

    function addRow(data = { asset: '', target_weight: 0, current_weight: 0, market_return: 0, price: 100 }) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value="${data.asset}"></td>
        <td><input type="number" value="${data.target_weight}" step="0.1"></td>
        <td><input type="number" value="${data.current_weight}" step="0.1"></td>
        <td><input type="number" value="${data.market_return}" step="0.1"></td>
        <td><input type="number" value="${data.price}" step="0.01"></td>
        <td><button type="button" class="danger">Remove</button></td>
      `;
      row.querySelector('button').addEventListener('click', () => row.remove());
      tbody.appendChild(row);
    }

    function collectPayload() {
      const assets = [...tbody.querySelectorAll('tr')].map((row) => {
        const inputs = row.querySelectorAll('input');
        const m = parseFloat(inputs[3].value || 0) / 100;
        return {
          asset: inputs[0].value || 'Unknown Asset',
          target_weight: parseFloat(inputs[1].value || 0) / 100,
          current_weight: parseFloat(inputs[2].value || 0) / 100,
          market_return: m,
          price: parseFloat(inputs[4].value || 100),
          historical_returns: [m * 0.2, m * 0.5, -m * 0.4, m * 0.8, m]
        };
      });

      return {
        portfolio_value: parseFloat(document.getElementById('portfolioValue').value || 100000),
        drift_threshold: parseFloat(document.getElementById('driftThreshold').value || 2) / 100,
        turnover_limit: parseFloat(document.getElementById('turnoverLimit').value || 20) / 100,
        transaction_cost_bps: parseFloat(document.getElementById('txCost').value || 10),
        assets
      };
    }

    async function loadScenarios() {
      const response = await fetch('/api/preview-scenarios');
      const payload = await response.json();
      scenarioData = payload.scenarios || [];
      const select = document.getElementById('scenarioSelect');
      select.innerHTML = '';
      scenarioData.forEach((scenario, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = scenario.name;
        select.appendChild(opt);
      });
      if (scenarioData.length > 0) {
        applyScenario(0);
      }
    }

    function applyScenario(index) {
      const scenario = scenarioData[index];
      if (!scenario) return;

      document.getElementById('portfolioValue').value = scenario.portfolio_value;
      document.getElementById('driftThreshold').value = scenario.drift_threshold * 100;
      document.getElementById('turnoverLimit').value = scenario.turnover_limit * 100;
      document.getElementById('txCost').value = scenario.transaction_cost_bps;
      document.getElementById('scenarioDescription').textContent = scenario.description;

      clearRows();
      scenario.assets.forEach((a) => addRow({
        asset: a.asset,
        target_weight: a.target_weight * 100,
        current_weight: a.current_weight * 100,
        market_return: a.market_return * 100,
        price: a.price,
      }));
    }

    async function runRebalance() {
      const response = await fetch('/api/rebalance', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(collectPayload())
      });
      const data = await response.json();
      document.getElementById('apiPreview').textContent = JSON.stringify(data, null, 2);

      resultBody.innerHTML = '';
      (data.weights || []).forEach((weight, idx) => {
        const trade = data.trades[idx];
        const row = document.createElement('tr');
        row.innerHTML = `<td>${weight.asset}</td>
          <td>${(weight.current_weight * 100).toFixed(2)}%</td>
          <td>${(weight.target_weight * 100).toFixed(2)}%</td>
          <td>${(weight.optimized_target_weight * 100).toFixed(2)}%</td>
          <td>${(weight.drift * 100).toFixed(2)}%</td>
          <td>${(weight.forecast_return * 100).toFixed(2)}%</td>
          <td>${trade.action}</td>
          <td>${trade.trade_value.toLocaleString()}</td>
          <td>${trade.trade_units.toLocaleString()}</td>
          <td>${trade.estimated_cost.toLocaleString()}</td>`;
        resultBody.appendChild(row);
      });

      document.getElementById('turnoverUsed').textContent = `${((data.turnover_used || 0) * 100).toFixed(2)}%`;
      document.getElementById('txCostTotal').textContent = `$${(data.estimated_total_transaction_cost || 0).toFixed(2)}`;
      document.getElementById('volatility').textContent = `${((data.risk_metrics?.volatility || 0) * 100).toFixed(2)}%`;
      document.getElementById('sharpe').textContent = (data.risk_metrics?.sharpe || 0).toFixed(2);
      document.getElementById('drawdown').textContent = `${((data.risk_metrics?.max_drawdown || 0) * 100).toFixed(2)}%`;
      document.getElementById('var95').textContent = `${((data.risk_metrics?.var_95 || 0) * 100).toFixed(2)}%`;
      document.getElementById('cvar95').textContent = `${((data.risk_metrics?.cvar_95 || 0) * 100).toFixed(2)}%`;
      document.getElementById('expRet').textContent = `${((data.risk_metrics?.expected_annual_return || 0) * 100).toFixed(2)}%`;
      document.getElementById('trackingError').textContent = `${((data.risk_metrics?.tracking_error || 0) * 100).toFixed(2)}%`;
      document.getElementById('mcLoss').textContent = `${((data.monte_carlo?.probability_of_loss || 0) * 100).toFixed(2)}%`;

      document.getElementById('convictionBuys').textContent = (data.house_view?.top_conviction_buys || []).join(', ');
      document.getElementById('riskReduction').textContent = (data.house_view?.risk_reduction_candidates || []).join(', ');

      const modelsList = document.getElementById('modelsList');
      modelsList.innerHTML = '';
      (data.house_view?.proposed_models || []).forEach((m) => {
        const li = document.createElement('li');
        li.textContent = m;
        modelsList.appendChild(li);
      });

      const agentList = document.getElementById('agentList');
      agentList.innerHTML = '';
      (data.multi_agent_blueprint?.agents || []).forEach((agent) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${agent.name}</strong>: ${agent.role}`;
        agentList.appendChild(li);
      });
      document.getElementById('agentFlow').textContent = data.multi_agent_blueprint?.orchestration || '-';
    }

    async function runCopilotBrief() {
      const response = await fetch('/api/ai-copilot/insights', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(collectPayload())
      });
      const data = await response.json();
      document.getElementById('copilotPreview').textContent = JSON.stringify(data, null, 2);
    }


    document.getElementById('addRowBtn').addEventListener('click', () => addRow());
    document.getElementById('runBtn').addEventListener('click', runRebalance);
    document.getElementById('copilotBtn').addEventListener('click', runCopilotBrief);
    document.getElementById('loadScenarioBtn').addEventListener('click', () => {
      const idx = parseInt(document.getElementById('scenarioSelect').value || '0', 10);
      applyScenario(idx);
      runRebalance();
    });

    defaultRows.forEach(addRow);
    loadScenarios().then(async () => {
      await runRebalance();
      await runCopilotBrief();
    });
  </script>
</body>
</html>
