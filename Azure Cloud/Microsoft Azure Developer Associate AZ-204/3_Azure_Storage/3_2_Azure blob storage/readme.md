- Azure blob storage
    - what is?
      - BLOB: Binary Large OBject
      - Object storage for cloud
        - Store unstructured data
          - Text files
            - .txt, .html, .json, .log
          - Binary files
            - Images, Videos
            - Zip files
            - PDFs
            - Virtual disks for VMs
        - Accessible via 
          - REST API over HTTP/HTTPS(recommended)
          - portal
          - CLI
          - Powershell
          - Azure Storage Client Library: for applications(uses REST API calls)
            - .NET, Java, Python, Node.js
    - Core concepts
        - Blob types
            - Block blob
                - Images, videos, text files or PDF documents
                - complete file/binary is replaced with new file
            - Append blob
                - log files
                - append is required at end of file
            - Page blob:
                - provides random read/write access
                - used for VHDs(Virtual disks)
      - Storage accounts
        - Data is always encrypted using storage service encryption(SSE)
        - Types
          - ***Storage V2(General purpose V2)***: default account
            - supports Blob, files, queues, table
            - blob supports block, append and page type blobs
            - high throughput, recommended option
            - Performance based
              - ***Standard performance***
                - uses magnetic drives/HDD
              - ***Premium performance***
                - uses SSDs
                - supports only blob storage: only page type of blob(block and append not supported)
                - not files, queues and table
                - i.e. only used as virtual hard disks(VHDs)
                - ***BlockBlobStorage account***
                  - To use block storage with premium performance
                  - supports block and append blob types
                  - for a lot of transactions with small objects
                - ***File Storage account***
                  - file service with premium performance
          - ***Storage(General purpose V1)***
            - old/legacy
            - supports Blob, files, queues, table
          - ***BlobStorage***
            - blob
            - old/legacy
          - V2 supports all replication strategies: LRS, GRS, ZRS, RA-GRS, GZRS, RA-GZRS(default)
            - RA-GZRS is default and is used in prod envs.
          - Legacy(Storage(V1) and BlobStorage) supports only LRS, GRS, RA-GRS
          - Premium performance(BlockBlob and File Storage) supports LRS, ZRS only
      - Containers
      - Replication strategies
        - LRS
        - ZRS
        - GRS Geo-redundant storage
        - RA-GRS Read-access geo-redundant storage
        - GZRS 
        - RA-GZRS Read-access Geo-Zone-redundant storage
    - Create storage account, container and blobs
      - [create storage account](create_storage_account.ps1)
        - [create storage account](create_storage_account.sh)
      - create blob container(for images and videos)
      - store blobs in blob container
      - via Portal
        - Storage accounts -> Blob service -> add container -> upload
    - Authorize Requests to blob storage
      - Shared key(Storage account key/access key) - used in [connection_strings](show_connection_string.ps1)
      - Shared Access Signatures(SAS) - tokens appended to blob URLs.
        - Portal -> storage account -> storage container/blob -> generate SAS token and URL
        - copy sas token and update URL-> https://storagename.net/path/file.jpg?Add_SAS_Token_here
      - Azure Active Directory
      - Anonymous public read access
        - Portal -> storage account -> storage container/blob -> change access level -> blob/container(url?comp=list will list all files in container)
    - Interact with data using appropriate SDK
      - Azure SDKs(https://azure.github.io/azure-sdk)
        - .NET(https://github.com/Azure/azure-sdk-for-net)
          - Collection of client libraries
          - azure.service-category.service-name
          - these client libraries are available as NuGet packages.
          - For blob storage use Azure.Storage.Blobs NuGet package
            - Contains and example usage:
              - ***BlobServiceClient***(for Blob Storage Account) 
                - to list all containers in the storage account
              - ***BlobContainerClient***(for Images/Container) 
                - to create a container or to list the blobs of a container.
              - ***BlobClient***(for blob) - 
                - upload/download a specific blob.
              - Others:
                - ***BlobClientOptions***
                  - provides client configuration options for connecting to Azure Blob Storage
                - ***BlobUriBuilder***
                  - to modify the contents of a Uri instance to point to different Azure Storage resources 
                    - like an account, container, or blob
          - for queue storage access, use Azure.Storage.Queue
        - Java
        - JavaScript/TypeScript
        - Python
        - C++
        - Android/iOS
    - Set and Retrieve properties and metadata
      - properties and metadata exists on blob containers and on blobs
      - these are set and retrieved via HTTP headers.
      - Portal -> Storage container -> settings -> properties and metadata
      - for Blob containers:
        - Properties:
          - System properties
            - ETag(read only): entity tag(string identifier that changes everytime when blob container is updated)
            - LastModified(read only): tells when the container was updated.
          - User-defined metadata
            - String-based key-value pairs stored on the container
      - for Blobs:
        - Properties:
            - System properties
                - ETag(read only): entity tag(string identifier that changes everytime when blob container is updated)
                - LastModified(read only): tells when the container was updated.
                - Content-Type: images/jpeg
                - Content-Length
                - x-ms-blob-type: block blob or append blob or page blob.
            - User-defined metadata
                - String-based key-value pairs stored on the container
      - Using REST to set and Retrieve properties and metadata
        - URI syntax to ***retrieve*** properties and metadata from containers and blobs
          - From container
            - GET/HEAD https://myacc.blob.core.windows.net/container_name?restype=container
          - From blob
            - GET/HEAD https://myacc.blob.core.windows.net/mycontainer/blob_name?comp=metadata
        - URI syntax to ***set*** properties and metadata from containers and blobs
        - From container
            - PUT https://myacc.blob.core.windows.net/container_name?restype=container
        - From blob
            - PUT https://myacc.blob.core.windows.net/container_name/blob_name?comp=metadata
    - Implement data archiving and retention
      - Implement hot(default for blob storage), cool and archive storage
        - Hot Access Tier(Default)
          - online storage
          - for frequently accessed data
          - high storage cost but low data access cost
          - faster access and retrieval
        - Cool Access Tier 
          - online storage
          - for infrequently accessed data stored for at least ***30 days***
          - low storage cost, high data access cost
        - Archive access tier:
          - offline storage
          - for very low frequency of data access
          - data not used for at least ***180 days***
      - [Set Access Tier](set_access_tier.sh)
      - Hot and cool tiers are online tiers and can be set at storage account level, Archive is offline tier and can only be set at Block blob level
      - Rehydrating
        - To access archive storage, we need to update it to hot/cool tier. This process is called rehydrating.
          - takes several hours to complete
          - Standard Priority
            - few minutes to 15 hours for data retrieval
          - High priority
            - In an hour data retrieval
      - Portal -> storage account -> blob -> change tier
      - [Transition blobs to cool and archive tiers](Transition_Blobs_to_Cool_and_Archive_Tiers.ps1)
    - Lifecycle management of blobs
      - portal -> storage account -> Blob service -> Lifecycle management -> Add rule -> e.g. move to cool storage if last accessed 15 days ago
      - Azure runs the rule once per day
      - [setup lifecycle management](setup_lifecycle_management_policies.ps1)
    - Enabling soft delete for blobs
      - Portal -> storage account -> Blob service -> data protection -> turn on safe delete for blobs
      - also works for snapshots and versions of blob.
        - Snapshot: read-only copy of blob at a specific point in time.(to save current state -> click on create snapshot in portal snapshot tab)
        - Versions: create version of a file
      - Leases
        - if lease is on, blob can be changed only using the lease id
        - turn on lease and get lease id:
          - portal -> blob file -> Acquire lease
      - Immutable blob storage
        - Immutable => cannot be changed
        - portal -> storage account -> blob -> settings -> access policy -> add policy for immutable blob storage
    - Move items in blob storage between storage accounts or containers
      - steps
        - copy items from source to target
        - delete the source
      - tools used to copy items in blob storage:
        - Azure CLI: blobs and containers 
          - [copy_blob.sh](copy_blob.sh)
        - AzCopy
          - [azcopy.sh](azcopy.sh)
          - to get SAS:
            - allow service: blob, file, queue, table 
          - for local copy
            - allow resource type: container, object 
            - portal -> blob -> shared access signature -> enable, generate SAS and copy blob service SAS URL
          - for container to container copy
            - portal -> blob -> shared access signature
            - Allow resource type: service, container, object -> copy blob service SAS URL
        - .NET client library for blob storage
        - set retrieve metadata using C#
          - https://github.com/ps-interactive/lab_azure_set-retrieve-properties-metadata-azure-blob-storage.git
          - [metadata](metadata.ps1)
- Azure Blob Storage lifecycle policies
  - [setup lifecycle management](setup_lifecycle_management_policies.ps1) 
  - [policy.json](policy.json)
    - each policy.json must have at least 1 rule, max 100 rules
  - Each rule has several parameters:
    - name - String
    - enabled(optional) - Boolean
    - type - enum
    - definition - Object
  - Each rule definition contains:
    - filter set
      - to limit rules to certain objects within a container 
    - action set
      - apply the tier or delete action to the filtered set of objects.
- Static site hosting(using block blob storage account)
  - Static => no web server is configured to render any content 
  - Via Portal, CLI or Powershell
  - Via portal
    - Enable static web hosting
      - portal -> Storage account -> Overview -> Capabilities -> static website -> enabled = true, default page = index.html, error = error.html
    - Upload files
      - portal -> Storage account -> Overview -> Upload -> upload blob -> select files and upload
      - store your static web content in a storage container called ***$web***
    - Enable metrics on static website pages
      - portal -> Storage account -> Monitor -> Metrics
