- Implement User Authentication and Authorization
  - Secure Azure Storage
    - 3 dimensions
      - Management Planes: who can manage permissions?
        - e.g. RBAC
          - Portal -> Storage account -> Access Control(IAM)
      - Data Plane: who can access data?
      - Encryption
        - Using Microsoft Key
        - using own key
    - Management Plane
      - RBAC
        - Role based access control
          - Roles
            - Security Principal: Somebody/Something that we want to grant access to. 
               - types:
                 - User
                 - group of users
                 - A Service(called Service Principal)
                   - [service_principal.sh](service_principal.sh)
                   - username/password
                   - works as an automated headless process running behind the scenes.
                   - A Service Principal in Microsoft Azure is a security identity used by applications, services, or automation tools to access specific Azure resources securely. It is a type of application identity that allows non-human entities (such as applications, scripts, or CI/CD pipelines) to authenticate and interact with Azure resources without the need for a user account or password.
                   - When you create a Service Principal, you will typically receive credentials, such as a Client ID and a Client Secret, or a certificate, which can be used to authenticate the application or script as the Service Principal and obtain an access token from Azure Active Directory (Azure AD). This access token is then used to make authorized requests to Azure resources.
                   - Using Service Principals instead of user accounts for automated tasks enhances security, as it allows you to manage access separately from user accounts and avoid the use of long-lived credentials.
                 - Managed Identity
                   - Service principal in disguise whose Credential is managed by Microsoft
            - Role definition
              - JSON permissions
                - actions
                - dataActions
                - notActions(denied Actions)
                - notDataActions(denied DataActions)
            - Scope
              - Management Group
              - Subscription
              - Resource Group
              - Resource
          - Role Assignment
            - attach role definition to a security principal on a scope(to grant/remove access to something)
            - Multiple role assignments are additive: e.g. Owner = Owner + contributor
            - Deny assignments can block access(takes precedence over everything else)
          - [Role Query](roles_query.sh)
      - Shared Access Signatures(SAS) and Stored access policies
        - [Shared Access Signatures](SAS_token_example.md)
          - Portal -> Storage account -> Shared access signature -> update details -> generate SAS and connection string
          - Secure, Delegated access without sharing the key
          - 3 Types of SAS:
            - ***User Delegation SAS***
              - for Azure AD
              - user impersonation scope is used so that user's permissions matter when we access Azure Storage.
              - works ***only for blob storage***
            - ***Service SAS***
              - secured with storage account key
              - delegates access to resource in ***only one*** of Azure Storage services either:
                - a Resource container or 
                - Blob storage or 
                - a Queue storage or 
                - Table storage or 
            - ***Account SAS***
              - Azure Files.
              - for ***entire storage account***
              - secured with storage account key.
              - delegates access to resources in ***one or more*** storage services.
              - supports all services offered by User Delegation and Service SAS.
              - Along with that, we can delegate access to operations at service level like get, set, service properties, get service, start operations etc.
              - we can also delegate access to read, write operations on containers, tables, queues, file shares that are not permitted with a services SAS.
          - Other types:
            - Ad-Hoc SAS
            - for user delegation/account type SAS
              - all info needed is available in the token itself.(permissions, start time, expire time, etc.)
            - Service SAS with Stored Access Policy
              - Portal -> Storage account -> container -> Access Policy
              - contains link to service access policy.
              - rules like permissions, start time, expire time, etc. are created and stored as a policy.
              - Characteristics
                - Reused by multiple SAS(used as a pointer to policies)
                - defined on a specific resource container(as it is a service SAS)
                - contains permissions and validity period
                - available as a service level SAS only

    - Data plane
       - Managing/Securing access to Azure Storage
       - 3 ways:
         - Storage Account Access Keys
            - 2(A,B)*512-bit storage account access keys are automatically generated by Azure when we create a new storage account.
            - Use key Vault to ***rotate keys***(that's why 2 keys are provided)
            - gives root-level access
            - shouldn't be directly embedded in the application
         - Shared Access Signature(SAS)
            - built on top of azure keys internally
            - allows to access things without sharing the keys
            - rotate keys to invalidate SAS
            - SAS are attached to URLs, specific permissions or range of time
         - Azure AD(Active Directory)
            - uses standard OpenID connect mechanisms.
            - no dependence on key
            - uses access tokens
            - duration is customizable(default: 1 hr)
  - Authentication vs Authorization
    - Authentication: who you are?
    - Authorization: what you can do?
  - Authenticate using azure AD
    - [Microsoft Identity Platform](microsoft_identity_platform.png)
      - Authentication service
        - Azure Active Directory(AAD)
          - Azure AD Connect
            - use to synchronize on-premise identities to cloud.
          - ADFS
            - federate authentication to a product called ADFS.
          - Pass-through
            - works through Azure AD connect.
        - Open-Source Libraries e.g. ADAL, MSAL, etc.
          - ADAL
            - older version of MSAL
            - to be depreciated
          - MSAL
            - Microsoft Authentication Library
            - OpenID connect complaint
            - family of libraries for diff. platforms(e.g. MSAL for .net, for Node.js, for Python etc.)
          - Microsoft.Identity.Web
            - for .NET core
            - target common auth scenarios 
        - Application Management Tools e.g. threat protection
          - Gallery and non gallery apps: 
            - Gallery apps: e.g. DropBox, Cisco Webex, Google apps.
              - All these can work with Azure AD
              - Hence, they are called gallery apps.
            - Non-Gallery apps: apps that are not very famous but uses standard protocol for auth
              - uses SAML or OpenID Connect
          - Single Tenant and Multi tenant apps
            - single tenant apps are designed to be used in your organization.
            - multi tenant apps are written by one org but used by many others. e.g. native mail app in android which can be used to login to gmail also.
          - Authorization
          - Consent
          - Logging: who was using thi app at some certain time, when was last token issued? etc.
      - open-source libraries
        - OpenID connect
            - open source libraries used for not supported languages like Ruby on Rails
      - application management tools.
    - Modern Authentication
      - Identity: Legacy vs Modern
        - Legacy
          - Basic Auth: passing username and password in header - not safe
          - NTLM: encrypted username and password.
          - Kerberos
            - Domain controller used to issue tickets
            - resource servers like exchange server on-premises gives a session granting ticket based on ticket-granting ticket
              - worked well in on-premises but didn't scale in cloud
        - Modern
          - Protocols:
            - WS-* and SAML
              - based on redirects and HTTP posts etc. designed originally for web browsers
              - but can be used in native apps or mobile apps.
            - OAuth
            - OpenID Connect
              - FLows for different types of applications
                - SPA/Public client(cannot be trusted with a secret)
                  - JavaScript Single-Page Application
                  - flows
                    - Implicit flow: old way
                    - PKCE: new way(recommended)
                - Native/Public client(cannot be trusted with a secret)
                  - WPF or Windows Forms, iOS mail app in iOS mobile(thick client apps natively installed in the device)
                  - Flow
                    - AuthCode without secret
                - Web/Confidential client(can be trusted with a secret)
                  - AuthCode with secret
                - Daemon or service
                  - No UI
                  - runs in background
                  - Flow
                    - Client Credential flow
                      - access token based
                - Limited UI
                  - IoT device
                  - Flows
                    - Device Code FLow
                      - secret is typed into a UI on a browser on an alternate machine with a non-limited interface.
              - Working of OpenID connect:
                - Uses access token which is sent as authorization header in HTTP request
                - token is validated by API and Azure AD using certificates using signature from token. 
                - If downstream API needs authentication, Azure AD provides another token
              - Token types
                - Access Tokens
                  - present to an API for authentication
                - ID Token
                  - user's ID
                - Refresh Token
                  - to get new access tokens when old token is about to expire
            - Distributed identity: upcoming
    - Register app using Azure AD
      - portal -> Azure Active Directory -> App Registrations -> new registration
    - Authenticate using Azure AD
  - Authorize
    - what you can do?
    - Entities
      - Apps
        - Service principals
        - Managed Identities
      - User
        - via Browser, iOS App, native app etc.
    - Authorization ways
      - Groups
        - groups in AAD
      - Custom claims
        - info that can be put on ID tokens or access tokens based on which we can drive authorization decisions.
        - e.g. auth based on user's country 
      - [App Roles](appManifestAttributes.md)
        - roles defined at app level in tokens
- Managed Identities
  - simple and secure way for apps to authenticate when connecting to resources 
    - that support Azure Active Directory(Azure AD)(part of Microsoft Entra) Authentication.
  - types of managed identities
    - ***System-assigned*** managed identities
      - created as a part of Azure resource, tied to configuration store
      - Shared life cycle with Azure resource that managed identity is created with
      - when parent source is deleted, managed identity is also deleted
        - i.e. deleted if config store is deleted.
      - A config store can have only one system-assigned identity.
        - i.e. it can't be shared
      - process
        - when app is deployed on a vm,
        - we can assign an identity to vm that has access to key vault.
        - for system-managed identities, account needs VM Contributor role assignment
          - no additional Azure AD role assignments are required
      - common use cases
        - Workloads that are contained within a single Azure Resource
        - Workloads for which we need independent identities 
    - ***User-assigned*** managed identities
      - Created as a stand-alone Azure resource assigned to config store
      - independent life cycle
      - must be explicitly deleted
      - can be shared
      - common use cases
        - workloads that run on multiple resources and can share single identity
        - workloads that need pre-authorization to a secure resource, as a part of provisioning flow.
      - workloads that run on multiple resources and can share a single identity.
      - A config store can have multiple user-assigned identities.
      - process:
        - create user-assigned managed identity using ```az identity create```
        - assign the identity to new VM.
        - [user_assigned_identity](user_assigned_identity.sh)
    - For both types of managed identity,
      - if app is running within a VM, app will have to retrieve the identity token from a special URI starting with https://169.254.169.254.
- Secured Access Signatures(SAS) Best Practices
  - Always use HTTPS
  - Apply minimum-required privileges
  - set expiration time to smallest useful time
  - most secure SAS is ***user delegation SAS***(used for blob storage only)
  - SAS isn't always the correct solution
    - When to use SAS
      - when workload on the application is storage heavy, app can directly share SAS with user to access data instead. 
    - when not to use SAS?
- Private endpoints vs Managed Identities
  - Private Endpoints for Azure App Configuration
    - configuring the firewall to block all connections to app configuration on public internet.
    - Increase security for VNet ensuring data doesn't escape VNet.
    - Securely connect to app configuration store from on-premises network that connect to the VNet
      - using VPN or ExpressRoutes with private-peering

- Azure Key Vault best practices
  - Logging
    - enable logging and alerts
  - Use separate key vaults
    - one vault per application per environment
  - control access to your vault
    - restrict key vault data as it is sensitive and business critical
  - backup
    - create regular backup of vault on update/delete/create of objects within a vault.
  - recovery
    - turn on soft-delete and purge protection to prevent force deletion of secrets.
- To access Azure resources using service principals, we need 2 parameters:
  - Directory ID
  - Application ID
- Uses of service principals:
  - Automated Deployments: Continuous Integration and Continuous Deployment (CI/CD) pipelines can use Service Principals to deploy and manage Azure resources automatically. 
  - Application Authentication: Service Principals can be used as application identities to access Azure resources securely from within an application. 
  - PowerShell or Azure CLI Scripts: Service Principals can be used in scripts to automate resource management tasks. 
  - Azure Virtual Machines: Service Principals can be assigned to virtual machines, allowing them to access other Azure resources without needing user credentials.
